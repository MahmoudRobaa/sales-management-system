<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المبيعات - محل الحاسوب والأدوات الكهربائية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', 'Geneva', 'Verdana', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            direction: rtl;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* الشريط الجانبي */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1000;
        }

        .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: white;
        }

        .logo p {
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        .menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #ecf0f1;
            text-decoration: none;
            transition: all 0.3s;
            border-right: 4px solid transparent;
            cursor: pointer;
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-right-color: var(--secondary-color);
            color: white;
        }

        .menu-item i {
            margin-left: 10px;
            font-size: 1.2rem;
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 20px;
            transition: all 0.3s;
        }

        .header {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info span {
            margin-left: 10px;
        }

        /* بطاقات الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 1.5rem;
            color: white;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .stat-info p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        /* الجداول */
        .content-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }

        .content-section.active-section {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .section-header h2 {
            color: var(--primary-color);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219653;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: right;
            color: var(--primary-color);
            font-weight: bold;
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
        }

        /* النماذج */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 700px;
            border-radius: 10px;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .close {
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }

        /* التبويبات */
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: bold;
            color: #7f8c8d;
        }

        .tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* تفاصيل المنتجات في الفاتورة */
        .product-item {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .product-info {
            flex: 1;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        /* البحث والتصفية */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        /* القائمة المنسدلة */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 1;
            border-radius: 5px;
            overflow: hidden;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 12px 20px;
            display: block;
            color: #333;
            text-decoration: none;
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        /* زر القائمة على الهواتف */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 5px;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 1002;
            cursor: pointer;
        }

        /* وسائط متجاوبة */
        @media (max-width: 992px) {
            .sidebar {
                right: -100%;
            }
            
            .sidebar.active {
                right: 0;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .stats-cards {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
        }

        /* رسائل التنبيه */
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-badge.success {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .status-badge.warning {
            background-color: #fef5e7;
            color: #f39c12;
        }
        
        .status-badge.danger {
            background-color: #fdedec;
            color: #e74c3c;
        }
        
        .status-badge.info {
            background-color: #e8f4fc;
            color: #3498db;
        }
    </style>
</head>
<body>
    <!-- زر القائمة للهواتف -->
    <div class="menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </div>

    <!-- الشريط الجانبي -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <h2>نظام إدارة المبيعات</h2>
            <p>محل الحاسوب والأدوات الكهربائية</p>
        </div>
        
        <div class="menu">
            <div class="menu-item active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>لوحة التحكم</span>
            </div>
            <div class="menu-item" data-section="products">
                <i class="fas fa-boxes"></i>
                <span>كارتة الأصناف</span>
            </div>
            <div class="menu-item" data-section="sales">
                <i class="fas fa-shopping-cart"></i>
                <span>المبيعات</span>
            </div>
            <div class="menu-item" data-section="purchases">
                <i class="fas fa-shopping-bag"></i>
                <span>المشتريات</span>
            </div>
            <div class="menu-item" data-section="inventory">
                <i class="fas fa-warehouse"></i>
                <span>المخازن</span>
            </div>
            <div class="menu-item" data-section="customers">
                <i class="fas fa-users"></i>
                <span>العملاء</span>
            </div>
            <div class="menu-item" data-section="suppliers">
                <i class="fas fa-truck"></i>
                <span>الموردين</span>
            </div>
            <div class="menu-item" data-section="reports">
                <i class="fas fa-chart-bar"></i>
                <span>التقارير</span>
            </div>
            <div class="menu-item" data-section="settings">
                <i class="fas fa-cog"></i>
                <span>الإعدادات</span>
            </div>
        </div>
        
        <div class="menu" style="margin-top: 30px;">
            <div class="menu-item" id="exportDataBtn">
                <i class="fas fa-file-export"></i>
                <span>تصدير البيانات</span>
            </div>
            <div class="menu-item" id="importDataBtn">
                <i class="fas fa-file-import"></i>
                <span>استيراد البيانات</span>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <div class="container">
        <div class="main-content" id="mainContent">
            <!-- لوحة التحكم -->
            <div id="dashboard" class="content-section active-section">
                <div class="header">
                    <h1>لوحة التحكم</h1>
                    <div class="user-info">
                        <i class="fas fa-user-circle fa-2x"></i>
                        <span>مدير النظام</span>
                    </div>
                </div>
                
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #3498db;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalSales">0 ج.م</h3>
                            <p>إجمالي المبيعات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #27ae60;">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalProducts">0</h3>
                            <p>إجمالي الأصناف</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #e74c3c;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCustomers">0</h3>
                            <p>إجمالي العملاء</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #f39c12;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="todayProfit">0 ج.م</h3>
                            <p>أرباح اليوم</p>
                        </div>
                    </div>
                </div>
                
                <div class="content-section">
                    <div class="section-header">
                        <h2>آخر المبيعات</h2>
                        <button class="btn btn-primary" onclick="showModal('saleModal')">
                            <i class="fas fa-plus"></i> إضافة عملية بيع
                        </button>
                    </div>
                    <div id="recentSalesTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>رقم الفاتورة</th>
                                    <th>التاريخ</th>
                                    <th>العميل</th>
                                    <th>المبلغ الإجمالي</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="recentSalesBody">
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="content-section">
                    <div class="section-header">
                        <h2>الأصناف المنخفضة بالمخزون</h2>
                    </div>
                    <div id="lowStockTable">
                        <table>
                            <thead>
                                <tr>
                                    <th>اسم الصنف</th>
                                    <th>الفئة</th>
                                    <th>الكمية المتاحة</th>
                                    <th>الحد الأدنى</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockBody">
                                <!-- سيتم ملؤها بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- كارتة الأصناف -->
            <div id="products" class="content-section">
                <div class="header">
                    <h1>كارتة الأصناف</h1>
                    <button class="btn btn-primary" onclick="showModal('productModal')">
                        <i class="fas fa-plus"></i> إضافة صنف جديد
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="productSearch" placeholder="بحث عن صنف..." onkeyup="filterProducts()">
                    <i class="fas fa-search"></i>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="filterProductsByCategory('all')">جميع الأصناف</div>
                    <div class="tab" onclick="filterProductsByCategory('computers')">أجهزة الكمبيوتر</div>
                    <div class="tab" onclick="filterProductsByCategory('electrical')">الأدوات الكهربائية</div>
                    <div class="tab" onclick="filterProductsByCategory('satellite')">مستلزمات الدش</div>
                </div>
                
                <div class="tab-content active" id="allProducts">
                    <table>
                        <thead>
                            <tr>
                                <th>كود الصنف</th>
                                <th>اسم الصنف</th>
                                <th>الفئة</th>
                                <th>سعر الشراء</th>
                                <th>سعر البيع</th>
                                <th>الكمية</th>
                                <th>الحد الأدنى</th>
                                <th>المورد</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            <!-- سيتم ملؤها بالبيانات -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- المبيعات -->
            <div id="sales" class="content-section">
                <div class="header">
                    <h1>إدارة المبيعات</h1>
                    <button class="btn btn-primary" onclick="showModal('saleModal')">
                        <i class="fas fa-plus"></i> عملية بيع جديدة
                    </button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>التاريخ</th>
                            <th>العميل</th>
                            <th>الكمية</th>
                            <th>المبلغ الإجمالي</th>
                            <th>المبلغ المدفوع</th>
                            <th>المتبقي</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <!-- المشتريات -->
            <div id="purchases" class="content-section">
                <div class="header">
                    <h1>إدارة المشتريات</h1>
                    <button class="btn btn-primary" onclick="showModal('purchaseModal')">
                        <i class="fas fa-plus"></i> عملية شراء جديدة
                    </button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>التاريخ</th>
                            <th>المورد</th>
                            <th>الكمية</th>
                            <th>المبلغ الإجمالي</th>
                            <th>المبلغ المدفوع</th>
                            <th>المتبقي</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="purchasesBody">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <!-- المخازن -->
            <div id="inventory" class="content-section">
                <div class="header">
                    <h1>إدارة المخازن</h1>
                    <div class="dropdown">
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> حركة جديدة
                        </button>
                        <div class="dropdown-content">
                            <div class="dropdown-item" onclick="showModal('adjustmentModal')">تعديل مخزون</div>
                            <div class="dropdown-item" onclick="showModal('transferModal')">تحويل بين المخازن</div>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="showInventoryTab('stockReport')">تقرير المخزون</div>
                    <div class="tab" onclick="showInventoryTab('movements')">حركة المخزون</div>
                    <div class="tab" onclick="showInventoryTab('categories')">الفئات</div>
                </div>
                
                <div class="tab-content active" id="stockReport">
                    <table>
                        <thead>
                            <tr>
                                <th>اسم الصنف</th>
                                <th>الفئة</th>
                                <th>الكمية</th>
                                <th>الحد الأدنى</th>
                                <th>تكلفة الوحدة</th>
                                <th>القيمة الإجمالية</th>
                                <th>المخزن</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody">
                            <!-- سيتم ملؤها بالبيانات -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- العملاء -->
            <div id="customers" class="content-section">
                <div class="header">
                    <h1>إدارة العملاء</h1>
                    <button class="btn btn-primary" onclick="showModal('customerModal')">
                        <i class="fas fa-plus"></i> إضافة عميل جديد
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="customerSearch" placeholder="بحث عن عميل..." onkeyup="filterCustomers()">
                    <i class="fas fa-search"></i>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>كود العميل</th>
                            <th>اسم العميل</th>
                            <th>الهاتف</th>
                            <th>البريد الإلكتروني</th>
                            <th>إجمالي المشتريات</th>
                            <th>الرصيد</th>
                            <th>تاريخ التسجيل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="customersBody">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <!-- الموردين -->
            <div id="suppliers" class="content-section">
                <div class="header">
                    <h1>إدارة الموردين</h1>
                    <button class="btn btn-primary" onclick="showModal('supplierModal')">
                        <i class="fas fa-plus"></i> إضافة مورد جديد
                    </button>
                </div>
                
                <div class="search-box">
                    <input type="text" id="supplierSearch" placeholder="بحث عن مورد..." onkeyup="filterSuppliers()">
                    <i class="fas fa-search"></i>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>كود المورد</th>
                            <th>اسم المورد</th>
                            <th>الهاتف</th>
                            <th>البريد الإلكتروني</th>
                            <th>العنوان</th>
                            <th>إجمالي المشتريات</th>
                            <th>الرصيد</th>
                            <th>تاريخ التسجيل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersBody">
                        <!-- سيتم ملؤها بالبيانات -->
                    </tbody>
                </table>
            </div>
            
            <!-- التقارير -->
            <div id="reports" class="content-section">
                <div class="header">
                    <h1>التقارير والتحليلات</h1>
                    <div class="dropdown">
                        <button class="btn btn-primary">
                            <i class="fas fa-file-export"></i> تصدير تقرير
                        </button>
                        <div class="dropdown-content">
                            <div class="dropdown-item" onclick="exportReport('sales')">تقرير المبيعات</div>
                            <div class="dropdown-item" onclick="exportReport('purchases')">تقرير المشتريات</div>
                            <div class="dropdown-item" onclick="exportReport('inventory')">تقرير المخزون</div>
                            <div class="dropdown-item" onclick="exportReport('customers')">تقرير العملاء</div>
                            <div class="dropdown-item" onclick="exportReport('profits')">تقرير الأرباح</div>
                        </div>
                    </div>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="showReportTab('profitReport')">تقرير الأرباح</div>
                    <div class="tab" onclick="showReportTab('salesReport')">تقرير المبيعات</div>
                    <div class="tab" onclick="showReportTab('inventoryReport')">تقرير المخزون</div>
                    <div class="tab" onclick="showReportTab('customerReport')">تقرير العملاء</div>
                </div>
                
                <div class="tab-content active" id="profitReport">
                    <div class="form-row">
                        <div class="form-group">
                            <label>من تاريخ</label>
                            <input type="date" id="profitFromDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>إلى تاريخ</label>
                            <input type="date" id="profitToDate" class="form-control">
                        </div>
                        <div class="form-group" style="align-self: flex-end;">
                            <button class="btn btn-primary" onclick="generateProfitReport()">عرض التقرير</button>
                        </div>
                    </div>
                    
                    <div class="content-section">
                        <h3>ملخص الأرباح</h3>
                        <div id="profitSummary">
                            <!-- سيتم ملؤها بالبيانات -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- الإعدادات -->
            <div id="settings" class="content-section">
                <div class="header">
                    <h1>إعدادات النظام</h1>
                </div>
                
                <div class="tabs">
                    <div class="tab active" onclick="showSettingsTab('generalSettings')">الإعدادات العامة</div>
                    <div class="tab" onclick="showSettingsTab('storeSettings')">إعدادات المحل</div>
                    <div class="tab" onclick="showSettingsTab('backupSettings')">النسخ الاحتياطي</div>
                </div>
                
                <div class="tab-content active" id="generalSettings">
                    <form id="settingsForm">
                        <div class="form-group">
                            <label>اسم المحل</label>
                            <input type="text" class="form-control" id="storeName" value="محل الحاسوب والأدوات الكهربائية">
                        </div>
                        
                        <div class="form-group">
                            <label>العنوان</label>
                            <input type="text" class="form-control" id="storeAddress" value="">
                        </div>
                        
                        <div class="form-group">
                            <label>هاتف المحل</label>
                            <input type="text" class="form-control" id="storePhone" value="">
                        </div>
                        
                        <div class="form-group">
                            <label>الحد الأدنى للتنبيه بالمخزون</label>
                            <input type="number" class="form-control" id="minStockAlert" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label>ضريبة القيمة المضافة (%)</label>
                            <input type="number" class="form-control" id="vatRate" value="15" step="0.1">
                        </div>
                        
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- النماذج (Modals) -->
    
    <!-- نموذج إضافة/تعديل صنف -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">إضافة صنف جديد</h3>
                <span class="close" onclick="closeModal('productModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="productForm" onsubmit="saveProduct(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>كود الصنف *</label>
                            <input type="text" class="form-control" id="productCode" required>
                        </div>
                        <div class="form-group">
                            <label>اسم الصنف *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الفئة *</label>
                            <select class="form-control" id="productCategory" required>
                                <option value="">اختر الفئة</option>
                                <option value="computers">أجهزة الكمبيوتر</option>
                                <option value="electrical">الأدوات الكهربائية</option>
                                <option value="satellite">مستلزمات الدش</option>
                                <option value="accessories">إكسسوارات</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المورد</label>
                            <select class="form-control" id="productSupplier">
                                <option value="">اختر المورد</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>سعر الشراء *</label>
                            <input type="number" class="form-control" id="purchasePrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>سعر البيع *</label>
                            <input type="number" class="form-control" id="salePrice" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الكمية *</label>
                            <input type="number" class="form-control" id="quantity" required>
                        </div>
                        <div class="form-group">
                            <label>الحد الأدنى</label>
                            <input type="number" class="form-control" id="minQuantity" value="5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>الوصف</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <input type="hidden" id="productId">
                    
                    <div class="form-group" style="text-align: left;">
                        <button type="submit" class="btn btn-success">حفظ</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('productModal')">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج عملية بيع -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>عملية بيع جديدة</h3>
                <span class="close" onclick="closeModal('saleModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>العميل</label>
                        <select class="form-control" id="saleCustomer">
                            <option value="">اختر العميل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>التاريخ</label>
                        <input type="date" class="form-control" id="saleDate" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>إضافة أصناف</label>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <select class="form-control" id="saleProduct">
                                <option value="">اختر الصنف</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" class="form-control" id="saleQuantity" placeholder="الكمية" value="1" min="1">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <input type="number" class="form-control" id="salePricePerUnit" placeholder="السعر" step="0.01">
                        </div>
                        <div class="form-group" style="flex: 1; align-self: flex-end;">
                            <button type="button" class="btn btn-primary" onclick="addProductToSale()">
                                <i class="fas fa-plus"></i> إضافة
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-section">
                    <h4>الأصناف المضافة</h4>
                    <div id="saleProductsList">
                        <!-- سيتم ملؤها بالأصناف المضافة -->
                        <p style="text-align: center; color: #7f8c8d; padding: 20px;">لم يتم إضافة أصناف بعد</p>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>المبلغ الإجمالي</label>
                        <input type="text" class="form-control" id="saleTotal" value="0.00" readonly>
                    </div>
                    <div class="form-group">
                        <label>الخصم</label>
                        <input type="number" class="form-control" id="saleDiscount" value="0" step="0.01" oninput="updateSaleTotals()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>المبلغ المدفوع</label>
                        <input type="number" class="form-control" id="salePaid" value="0" step="0.01" oninput="updateSaleTotals()">
                    </div>
                    <div class="form-group">
                        <label>المبلغ المتبقي</label>
                        <input type="text" class="form-control" id="saleRemaining" value="0.00" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea class="form-control" id="saleNotes" rows="2"></textarea>
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <button type="button" class="btn btn-success" onclick="saveSale()">حفظ العملية</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('saleModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- نموذج عملية شراء -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>عملية شراء جديدة</h3>
                <span class="close" onclick="closeModal('purchaseModal')">&times;</span>
            </div>
            <div class="modal-body">
                <!-- محتوى نموذج الشراء -->
                <p>نموذج الشراء سيكون مشابه لنموذج البيع مع تعديلات بسيطة</p>
                <button type="button" class="btn btn-danger" onclick="closeModal('purchaseModal')">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- نموذج إضافة عميل -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">إضافة عميل جديد</h3>
                <span class="close" onclick="closeModal('customerModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="customerForm" onsubmit="saveCustomer(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>كود العميل</label>
                            <input type="text" class="form-control" id="customerCode" readonly>
                        </div>
                        <div class="form-group">
                            <label>اسم العميل *</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الهاتف *</label>
                            <input type="tel" class="form-control" id="customerPhone" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="customerEmail">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                    </div>
                    
                    <input type="hidden" id="customerId">
                    
                    <div class="form-group" style="text-align: left;">
                        <button type="submit" class="btn btn-success">حفظ</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('customerModal')">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج إضافة مورد -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="supplierModalTitle">إضافة مورد جديد</h3>
                <span class="close" onclick="closeModal('supplierModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="supplierForm" onsubmit="saveSupplier(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>كود المورد</label>
                            <input type="text" class="form-control" id="supplierCode" readonly>
                        </div>
                        <div class="form-group">
                            <label>اسم المورد *</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الهاتف *</label>
                            <input type="tel" class="form-control" id="supplierPhone" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="supplierEmail">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>العنوان</label>
                        <textarea class="form-control" id="supplierAddress" rows="2"></textarea>
                    </div>
                    
                    <input type="hidden" id="supplierId">
                    
                    <div class="form-group" style="text-align: left;">
                        <button type="submit" class="btn btn-success">حفظ</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('supplierModal')">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج تعديل المخزون -->
    <div id="adjustmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تعديل كمية المخزون</h3>
                <span class="close" onclick="closeModal('adjustmentModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="adjustmentForm" onsubmit="saveAdjustment(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الصنف</label>
                            <select class="form-control" id="adjustmentProduct" required onchange="updateCurrentQuantity()">
                                <option value="">اختر الصنف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نوع التعديل</label>
                            <select class="form-control" id="adjustmentType" required>
                                <option value="add">زيادة</option>
                                <option value="subtract">نقصان</option>
                                <option value="set">تعيين قيمة جديدة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>الكمية الحالية</label>
                            <input type="number" class="form-control" id="currentQuantity" readonly>
                        </div>
                        <div class="form-group">
                            <label>الكمية الجديدة *</label>
                            <input type="number" class="form-control" id="newQuantity" required min="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>سبب التعديل</label>
                        <select class="form-control" id="adjustmentReason">
                            <option value="damage">تلف</option>
                            <option value="expired">منتهي الصلاحية</option>
                            <option value="count_error">خطأ في العد</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea class="form-control" id="adjustmentNotes" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group" style="text-align: left;">
                        <button type="submit" class="btn btn-success">حفظ التعديل</button>
                        <button type="button" class="btn btn-danger" onclick="closeModal('adjustmentModal')">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- نموذج تصدير البيانات -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تصدير البيانات</h3>
                <span class="close" onclick="closeModal('exportModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>نوع البيانات للتصدير</label>
                    <select class="form-control" id="exportType">
                        <option value="products">الأصناف</option>
                        <option value="sales">المبيعات</option>
                        <option value="purchases">المشتريات</option>
                        <option value="customers">العملاء</option>
                        <option value="suppliers">الموردين</option>
                        <option value="all">جميع البيانات</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>من تاريخ</label>
                        <input type="date" class="form-control" id="exportFromDate">
                    </div>
                    <div class="form-group">
                        <label>إلى تاريخ</label>
                        <input type="date" class="form-control" id="exportToDate">
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check" style="margin-bottom: 10px;">
                        <input type="checkbox" class="form-check-input" id="exportIncludeHeaders" checked>
                        <label class="form-check-label" for="exportIncludeHeaders">تضمين رؤوس الأعمدة</label>
                    </div>
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <button type="button" class="btn btn-success" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> تصدير إلى Excel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> تصدير إلى PDF
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('exportModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج استيراد البيانات -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>استيراد البيانات</h3>
                <span class="close" onclick="closeModal('importModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>نوع البيانات للاستيراد</label>
                    <select class="form-control" id="importType">
                        <option value="products">الأصناف</option>
                        <option value="customers">العملاء</option>
                        <option value="suppliers">الموردين</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ملف Excel للاستيراد</label>
                    <input type="file" class="form-control" id="importFile" accept=".xlsx, .xls, .csv">
                    <small style="color: #7f8c8d;">يجب أن يكون الملف بصيغة Excel أو CSV</small>
                </div>
                
                <div class="form-group">
                    <div class="form-check" style="margin-bottom: 10px;">
                        <input type="checkbox" class="form-check-input" id="importUpdateExisting" checked>
                        <label class="form-check-label" for="importUpdateExisting">تحديث البيانات الموجودة</label>
                    </div>
                </div>
                
                <div id="importPreview" style="margin-top: 20px; display: none;">
                    <h4>معاينة البيانات</h4>
                    <div id="importPreviewTable" style="overflow: auto; max-height: 200px;"></div>
                </div>
                
                <div class="form-group" style="text-align: left;">
                    <button type="button" class="btn btn-success" onclick="importFromExcel()">استيراد البيانات</button>
                    <button type="button" class="btn btn-danger" onclick="closeModal('importModal')">إلغاء</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج طباعة الفاتورة -->
    <div id="invoiceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>فاتورة مبيعات</h3>
                <span class="close" onclick="closeModal('invoiceModal')">&times;</span>
            </div>
            <div class="modal-body">
                <div id="invoiceContent">
                    <!-- سيتم ملؤها بمحتوى الفاتورة -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="printInvoice()">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج نقل المخزون -->
    <div id="transferModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تحويل بين المخازن</h3>
                <span class="close" onclick="closeModal('transferModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>هذا النموذج قيد التطوير</p>
                <button type="button" class="btn btn-danger" onclick="closeModal('transferModal')">إغلاق</button>
            </div>
        </div>
    </div>

    <script>
        // ========== المتغيرات العامة ==========
        let products = [];
        let customers = [];
        let suppliers = [];
        let sales = [];
        let purchases = [];
        let inventoryMovements = [];
        let settings = {};
        let saleProducts = []; // الأصناف في عملية البيع الحالية
        let currentCategoryFilter = 'all'; // الفئة الحالية للتصفية

        // ========== تهيئة النظام ==========
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            loadDataFromStorage();
            setupEventListeners();
            loadDashboardData();
            loadProductsTable();
            loadCustomersTable();
            loadSuppliersTable();
            loadSalesTable();
            loadPurchasesTable();
            loadInventoryTable();
            updateSettingsForm();
        }

        function loadDataFromStorage() {
            // تحميل البيانات من localStorage أو استخدام بيانات افتراضية
            products = JSON.parse(localStorage.getItem('products')) || getDefaultProducts();
            customers = JSON.parse(localStorage.getItem('customers')) || getDefaultCustomers();
            suppliers = JSON.parse(localStorage.getItem('suppliers')) || getDefaultSuppliers();
            sales = JSON.parse(localStorage.getItem('sales')) || [];
            purchases = JSON.parse(localStorage.getItem('purchases')) || [];
            inventoryMovements = JSON.parse(localStorage.getItem('inventoryMovements')) || [];
            settings = JSON.parse(localStorage.getItem('settings')) || getDefaultSettings();
        }

        function setupEventListeners() {
            // القائمة الجانبية
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // تحديث القائمة النشطة
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // إغلاق القائمة على الهواتف
                    if (window.innerWidth <= 992) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });
            
            // زر القائمة على الهواتف
            document.getElementById('menuToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('active');
            });
            
            // تصدير البيانات
            document.getElementById('exportDataBtn').addEventListener('click', function() {
                showModal('exportModal');
            });
            
            // استيراد البيانات
            document.getElementById('importDataBtn').addEventListener('click', function() {
                showModal('importModal');
            });
            
            // معاينة ملف الاستيراد
            document.getElementById('importFile').addEventListener('change', previewImportFile);
            
            // تحديث سعر المنتج عند اختياره في البيع
            document.getElementById('saleProduct').addEventListener('change', function() {
                const productId = parseInt(this.value);
                if (productId) {
                    const product = products.find(p => p.id === productId);
                    if (product) {
                        document.getElementById('salePricePerUnit').value = product.salePrice;
                    }
                }
            });
        }

        // ========== البيانات الافتراضية ==========
        function getDefaultProducts() {
            return [
                {
                    id: 1,
                    code: 'PROD001',
                    name: 'لوحة مفاتيح لاسلكية',
                    category: 'computers',
                    purchasePrice: 45,
                    salePrice: 80,
                    quantity: 25,
                    minQuantity: 5,
                    supplier: 'المورد التقني',
                    description: 'لوحة مفاتيح لاسلكية من نوع لوجيتك'
                },
                {
                    id: 2,
                    code: 'PROD002',
                    name: 'ماوس لاسلكي',
                    category: 'computers',
                    purchasePrice: 25,
                    salePrice: 50,
                    quantity: 40,
                    minQuantity: 5,
                    supplier: 'المورد التقني',
                    description: 'ماوس لاسلكي من نوع لوجيتك'
                },
                {
                    id: 3,
                    code: 'PROD003',
                    name: 'ريسيفر ديجيتال',
                    category: 'satellite',
                    purchasePrice: 120,
                    salePrice: 200,
                    quantity: 15,
                    minQuantity: 3,
                    supplier: 'شركة الأقمار الصناعية',
                    description: 'ريسيفر ديجيتال عالي الجودة'
                },
                {
                    id: 4,
                    code: 'PROD004',
                    name: 'سلك HDMI',
                    category: 'accessories',
                    purchasePrice: 15,
                    salePrice: 30,
                    quantity: 60,
                    minQuantity: 10,
                    supplier: 'شركة الكابلات',
                    description: 'سلك HDMI بطول 2 متر'
                },
                {
                    id: 5,
                    code: 'PROD005',
                    name: 'مروحة مكتب',
                    category: 'electrical',
                    purchasePrice: 60,
                    salePrice: 110,
                    quantity: 12,
                    minQuantity: 3,
                    supplier: 'شركة الأجهزة الكهربائية',
                    description: 'مروحة مكتب صغيرة'
                }
            ];
        }

        function getDefaultCustomers() {
            return [
                {id: 1, code: 'CUST001', name: 'أحمد محمد', phone: '01012345678', email: 'ahmed@example.com', address: 'القاهرة', totalPurchases: 1500, balance: 0, regDate: '2024-01-15'},
                {id: 2, code: 'CUST002', name: 'محمد علي', phone: '01123456789', email: 'mohamed@example.com', address: 'الجيزة', totalPurchases: 3200, balance: 500, regDate: '2024-02-10'},
                {id: 3, code: 'CUST003', name: 'سارة خالد', phone: '01234567890', email: 'sara@example.com', address: 'الإسكندرية', totalPurchases: 800, balance: 0, regDate: '2024-03-05'}
            ];
        }

        function getDefaultSuppliers() {
            return [
                {id: 1, code: 'SUPP001', name: 'المورد التقني', phone: '01098765432', email: 'tech@example.com', address: 'القاهرة', totalPurchases: 50000, balance: 0, regDate: '2024-01-01'},
                {id: 2, code: 'SUPP002', name: 'شركة الأقمار الصناعية', phone: '01187654321', email: 'satellite@example.com', address: 'الجيزة', totalPurchases: 30000, balance: 5000, regDate: '2024-01-10'},
                {id: 3, code: 'SUPP003', name: 'شركة الأجهزة الكهربائية', phone: '01276543210', email: 'electrical@example.com', address: 'الإسكندرية', totalPurchases: 25000, balance: 0, regDate: '2024-02-01'}
            ];
        }

        function getDefaultSettings() {
            return {
                storeName: 'محل الحاسوب والأدوات الكهربائية',
                storeAddress: 'شارع الرئيسي - المدينة',
                storePhone: '01000000000',
                minStockAlert: 5,
                vatRate: 15
            };
        }

        // ========== إدارة الأقسام ==========
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active-section');
            });
            
            // إظهار القسم المطلوب
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active-section');
                
                // تحديث العنوان
                const menuItem = document.querySelector(`[data-section="${sectionId}"] span`);
                if (menuItem) {
                    document.querySelector('.header h1').textContent = menuItem.textContent;
                }
            }
        }

        function showInventoryTab(tabId) {
            // تحديث التبويبات
            document.querySelectorAll('#inventory .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // تحديط المحتوى
            document.querySelectorAll('#inventory .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function showReportTab(tabId) {
            // تحديث التبويبات
            document.querySelectorAll('#reports .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // تحديط المحتوى
            document.querySelectorAll('#reports .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        function showSettingsTab(tabId) {
            // تحديث التبويبات
            document.querySelectorAll('#settings .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // تحديط المحتوى
            document.querySelectorAll('#settings .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        // ========== إدارة النماذج المنبثقة ==========
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // تهيئة النماذج حسب الحاجة
            switch(modalId) {
                case 'productModal':
                    initProductForm();
                    break;
                case 'saleModal':
                    initSaleForm();
                    break;
                case 'customerModal':
                    initCustomerForm();
                    break;
                case 'supplierModal':
                    initSupplierForm();
                    break;
                case 'adjustmentModal':
                    initAdjustmentForm();
                    break;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ========== لوحة التحكم ==========
        function loadDashboardData() {
            // إجمالي المبيعات
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            
            // إجمالي الأصناف
            document.getElementById('totalProducts').textContent = products.length;
            
            // إجمالي العملاء
            document.getElementById('totalCustomers').textContent = customers.length;
            
            // أرباح اليوم
            const today = new Date().toISOString().split('T')[0];
            const todaySales = sales.filter(sale => sale.date === today);
            const todayProfit = todaySales.reduce((profit, sale) => {
                const saleProfit = sale.items.reduce((sum, item) => {
                    const product = products.find(p => p.id === item.productId);
                    return sum + (item.price - (product ? product.purchasePrice : 0)) * item.quantity;
                }, 0);
                return profit + saleProfit;
            }, 0);
            document.getElementById('todayProfit').textContent = formatCurrency(todayProfit);
            
            // آخر المبيعات
            loadRecentSales();
            
            // الأصناف المنخفضة
            loadLowStockProducts();
        }

        function loadRecentSales() {
            const tbody = document.getElementById('recentSalesBody');
            tbody.innerHTML = '';
            
            const recentSales = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            recentSales.forEach(sale => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.invoiceNo}</td>
                    <td>${sale.date}</td>
                    <td>${sale.customerName}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td><span class="status-badge ${getStatusClass(sale.status)}">${sale.status}</span></td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="viewSale(${sale.id})">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="action-btn" style="background-color: #f39c12;" onclick="printSaleInvoice(${sale.id})">
                                <i class="fas fa-print"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadLowStockProducts() {
            const tbody = document.getElementById('lowStockBody');
            tbody.innerHTML = '';
            
            const minStockAlert = settings.minStockAlert || 5;
            const lowStockProducts = products.filter(p => p.quantity <= p.minQuantity || p.quantity <= minStockAlert);
            
            lowStockProducts.forEach(product => {
                const status = product.quantity === 0 ? 'نفذ من المخزون' : 
                              product.quantity <= (product.minQuantity / 2) ? 'منخفض جدًا' : 'منخفض';
                const statusClass = product.quantity === 0 ? 'danger' : 
                                   product.quantity <= (product.minQuantity / 2) ? 'warning' : 'info';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${getCategoryName(product.category)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.minQuantity}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========== إدارة الأصناف ==========
        function loadProductsTable() {
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';
            
            const filteredProducts = filterProductsByCategoryAndSearch(currentCategoryFilter, '');
            
            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${getCategoryName(product.category)}</td>
                    <td>${formatCurrency(product.purchasePrice)}</td>
                    <td>${formatCurrency(product.salePrice)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.minQuantity}</td>
                    <td>${product.supplier || '-'}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #27ae60;" onclick="adjustProductStock(${product.id})">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            loadProductsTableWithFilter(currentCategoryFilter, searchTerm);
        }

        function filterProductsByCategory(category) {
            currentCategoryFilter = category;
            
            // تحديث التبويبات
            document.querySelectorAll('#products .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadProductsTableWithFilter(category, '');
        }

        function loadProductsTableWithFilter(category, searchTerm) {
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';
            
            const filteredProducts = filterProductsByCategoryAndSearch(category, searchTerm);
            
            filteredProducts.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.code}</td>
                    <td>${product.name}</td>
                    <td>${getCategoryName(product.category)}</td>
                    <td>${formatCurrency(product.purchasePrice)}</td>
                    <td>${formatCurrency(product.salePrice)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.minQuantity}</td>
                    <td>${product.supplier || '-'}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #27ae60;" onclick="adjustProductStock(${product.id})">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterProductsByCategoryAndSearch(category, searchTerm) {
            return products.filter(product => {
                // الفلترة حسب الفئة
                if (category !== 'all' && product.category !== category) {
                    return false;
                }
                
                // الفلترة حسب البحث
                if (searchTerm && 
                    !product.name.toLowerCase().includes(searchTerm) &&
                    !product.code.toLowerCase().includes(searchTerm) &&
                    !getCategoryName(product.category).toLowerCase().includes(searchTerm) &&
                    !(product.supplier && product.supplier.toLowerCase().includes(searchTerm))) {
                    return false;
                }
                
                return true;
            });
        }

        function initProductForm() {
            document.getElementById('productModalTitle').textContent = 'إضافة صنف جديد';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            
            // توليد كود جديد
            const nextId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
            document.getElementById('productCode').value = 'PROD' + nextId.toString().padStart(3, '0');
            
            // ملء قائمة الموردين
            populateSuppliersSelect('productSupplier');
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const product = {
                id: productId ? parseInt(productId) : products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1,
                code: document.getElementById('productCode').value,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value),
                salePrice: parseFloat(document.getElementById('salePrice').value),
                quantity: parseInt(document.getElementById('quantity').value),
                minQuantity: parseInt(document.getElementById('minQuantity').value),
                supplier: document.getElementById('productSupplier').value,
                description: document.getElementById('productDescription').value
            };
            
            if (productId) {
                // تعديل منتج موجود
                const index = products.findIndex(p => p.id === parseInt(productId));
                if (index !== -1) {
                    products[index] = product;
                }
            } else {
                // إضافة منتج جديد
                products.push(product);
            }
            
            saveToStorage('products', products);
            closeModal('productModal');
            loadProductsTable();
            loadDashboardData();
            loadInventoryTable();
            showMessage('تم حفظ المنتج بنجاح', 'success');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productModalTitle').textContent = 'تعديل الصنف';
                document.getElementById('productId').value = product.id;
                document.getElementById('productCode').value = product.code;
                document.getElementById('productName').value = product.name;
                document.getElementById('productCategory').value = product.category;
                document.getElementById('purchasePrice').value = product.purchasePrice;
                document.getElementById('salePrice').value = product.salePrice;
                document.getElementById('quantity').value = product.quantity;
                document.getElementById('minQuantity').value = product.minQuantity;
                document.getElementById('productSupplier').value = product.supplier;
                document.getElementById('productDescription').value = product.description;
                
                showModal('productModal');
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                const index = products.findIndex(p => p.id === id);
                if (index !== -1) {
                    products.splice(index, 1);
                    saveToStorage('products', products);
                    loadProductsTable();
                    loadDashboardData();
                    loadInventoryTable();
                    showMessage('تم حذف المنتج بنجاح', 'success');
                }
            }
        }

        // ========== إدارة المبيعات ==========
        function loadSalesTable() {
            const tbody = document.getElementById('salesBody');
            tbody.innerHTML = '';
            
            sales.forEach(sale => {
                const totalItems = sale.items.reduce((sum, item) => sum + item.quantity, 0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.invoiceNo}</td>
                    <td>${sale.date}</td>
                    <td>${sale.customerName}</td>
                    <td>${totalItems}</td>
                    <td>${formatCurrency(sale.total)}</td>
                    <td>${formatCurrency(sale.paid)}</td>
                    <td>${formatCurrency(sale.remaining)}</td>
                    <td><span class="status-badge ${getStatusClass(sale.status)}">${sale.status}</span></td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="viewSale(${sale.id})">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="action-btn" style="background-color: #f39c12;" onclick="printSaleInvoice(${sale.id})">
                                <i class="fas fa-print"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteSale(${sale.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function initSaleForm() {
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleDiscount').value = 0;
            document.getElementById('salePaid').value = 0;
            document.getElementById('saleNotes').value = '';
            document.getElementById('saleCustomer').value = '';
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('salePricePerUnit').value = '';
            saleProducts = [];
            
            // تحديث قائمة المنتجات والعملاء
            populateProductsSelect('saleProduct');
            populateCustomersSelect('saleCustomer');
            
            // تحديث عرض المنتجات
            updateSaleProductsList();
            updateSaleTotals();
        }

        function populateProductsSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">اختر الصنف</option>';
            
            products.filter(p => p.quantity > 0).forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.quantity} متاح) - ${formatCurrency(product.salePrice)}`;
                select.appendChild(option);
            });
        }

        function populateCustomersSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">اختر العميل</option><option value="0">عميل نقدي</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.phone}`;
                select.appendChild(option);
            });
        }

        function populateSuppliersSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">اختر المورد</option>';
            
            suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.name;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
        }

        function addProductToSale() {
            const productId = parseInt(document.getElementById('saleProduct').value);
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            const price = parseFloat(document.getElementById('salePricePerUnit').value);
            
            if (!productId || quantity < 1) {
                showMessage('يرجى اختيار منتج وكمية صحيحة', 'error');
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) {
                showMessage('المنتج غير موجود', 'error');
                return;
            }
            
            if (quantity > product.quantity) {
                showMessage(`الكمية المطلوبة غير متاحة. المتاح: ${product.quantity}`, 'error');
                return;
            }
            
            const salePrice = price || product.salePrice;
            const total = salePrice * quantity;
            
            // إضافة المنتج لقائمة البيع
            const existingIndex = saleProducts.findIndex(p => p.id === productId);
            if (existingIndex !== -1) {
                saleProducts[existingIndex].quantity += quantity;
                saleProducts[existingIndex].total += total;
            } else {
                saleProducts.push({
                    id: productId,
                    name: product.name,
                    quantity: quantity,
                    price: salePrice,
                    total: total
                });
            }
            
            // تحديث العرض
            updateSaleProductsList();
            updateSaleTotals();
            
            // إعادة تعيين الحقول
            document.getElementById('saleProduct').value = '';
            document.getElementById('saleQuantity').value = 1;
            document.getElementById('salePricePerUnit').value = '';
        }

        function updateSaleProductsList() {
            const list = document.getElementById('saleProductsList');
            list.innerHTML = '';
            
            if (saleProducts.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">لم يتم إضافة أصناف بعد</p>';
                return;
            }
            
            saleProducts.forEach((product, index) => {
                const item = document.createElement('div');
                item.className = 'product-item';
                item.innerHTML = `
                    <div class="product-info">
                        <strong>${product.name}</strong>
                        <div style="color: #7f8c8d; font-size: 0.9rem;">
                            ${product.quantity} × ${formatCurrency(product.price)} = ${formatCurrency(product.total)}
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-warning btn-sm" onclick="editSaleProduct(${index})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="removeSaleProduct(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateSaleTotals() {
            const total = saleProducts.reduce((sum, product) => sum + product.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const paid = parseFloat(document.getElementById('salePaid').value) || 0;
            const remaining = total - discount - paid;
            
            document.getElementById('saleTotal').value = total.toFixed(2);
            document.getElementById('saleRemaining').value = remaining.toFixed(2);
        }

        function saveSale() {
            if (saleProducts.length === 0) {
                showMessage('يرجى إضافة أصناف للبيع', 'error');
                return;
            }
            
            const customerId = parseInt(document.getElementById('saleCustomer').value) || 0;
            const customer = customers.find(c => c.id === customerId);
            const customerName = customer ? customer.name : 'عميل نقدي';
            
            const total = saleProducts.reduce((sum, product) => sum + product.total, 0);
            const discount = parseFloat(document.getElementById('saleDiscount').value) || 0;
            const paid = parseFloat(document.getElementById('salePaid').value) || 0;
            const remaining = total - discount - paid;
            const status = remaining === 0 ? 'مدفوعة' : paid === 0 ? 'غير مدفوعة' : 'جزئي';
            
            const sale = {
                id: sales.length > 0 ? Math.max(...sales.map(s => s.id)) + 1 : 1,
                invoiceNo: 'INV' + (sales.length + 1).toString().padStart(3, '0'),
                date: document.getElementById('saleDate').value,
                customerId: customerId,
                customerName: customerName,
                items: saleProducts.map(p => ({
                    productId: p.id,
                    productName: p.name,
                    quantity: p.quantity,
                    price: p.price,
                    total: p.total
                })),
                total: total,
                discount: discount,
                paid: paid,
                remaining: remaining,
                status: status,
                notes: document.getElementById('saleNotes').value
            };
            
            // تحديث كمية المخزون
            let hasError = false;
            sale.items.forEach(item => {
                const productIndex = products.findIndex(p => p.id === item.productId);
                if (productIndex !== -1) {
                    if (products[productIndex].quantity < item.quantity) {
                        showMessage(`الكمية غير كافية للمنتج ${item.productName}`, 'error');
                        hasError = true;
                        return;
                    }
                    products[productIndex].quantity -= item.quantity;
                }
            });
            
            if (hasError) return;
            
            // تحديث بيانات العميل إذا كان معروفًا
            if (customer) {
                const customerIndex = customers.findIndex(c => c.id === customerId);
                if (customerIndex !== -1) {
                    customers[customerIndex].totalPurchases += total;
                    customers[customerIndex].balance += remaining;
                }
            }
            
            // حفظ البيانات
            sales.push(sale);
            saveToStorage('sales', sales);
            saveToStorage('products', products);
            saveToStorage('customers', customers);
            
            // إغلاق النموذج وتحديث البيانات
            closeModal('saleModal');
            loadSalesTable();
            loadProductsTable();
            loadCustomersTable();
            loadDashboardData();
            loadInventoryTable();
            
            // إظهار رسالة نجاح وطباعة الفاتورة
            showMessage('تم حفظ عملية البيع بنجاح', 'success');
            setTimeout(() => printSaleInvoice(sale.id), 500);
        }

        function viewSale(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            let invoiceContent = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>${settings.storeName || 'محل الحاسوب والأدوات الكهربائية'}</h2>
                    ${settings.storeAddress ? `<p>${settings.storeAddress}</p>` : ''}
                    ${settings.storePhone ? `<p>هاتف: ${settings.storePhone}</p>` : ''}
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <strong>فاتورة رقم:</strong> ${sale.invoiceNo}<br>
                        <strong>التاريخ:</strong> ${sale.date}<br>
                        <strong>العميل:</strong> ${sale.customerName}
                    </div>
                    <div style="text-align: left;">
                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <strong>الحالة:</strong> <span style="color: ${sale.status === 'مدفوعة' ? 'green' : sale.status === 'جزئي' ? 'orange' : 'red'}">${sale.status}</span>
                        </div>
                    </div>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; border: 1px solid #ddd;">اسم الصنف</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">الكمية</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">السعر</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">الإجمالي</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sale.items.forEach(item => {
                invoiceContent += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;">${item.productName}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: left;">${formatCurrency(item.price)}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: left;">${formatCurrency(item.total)}</td>
                    </tr>
                `;
            });
            
            invoiceContent += `
                    </tbody>
                </table>
                
                <div style="text-align: left; margin-left: auto; width: 300px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>الإجمالي:</span>
                        <span>${formatCurrency(sale.total)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>الخصم:</span>
                        <span>${formatCurrency(sale.discount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                        <span>الصافي:</span>
                        <span>${formatCurrency(sale.total - sale.discount)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>المدفوع:</span>
                        <span>${formatCurrency(sale.paid)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; border-top: 2px solid #333; padding-top: 10px;">
                        <span>المتبقي:</span>
                        <span>${formatCurrency(sale.remaining)}</span>
                    </div>
                </div>
                
                ${sale.notes ? `<div style="margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">
                    <strong>ملاحظات:</strong> ${sale.notes}
                </div>` : ''}
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd;">
                    <p>شكراً لثقتكم بنا</p>
                    <p>للاستفسار: ${settings.storePhone || '01000000000'}</p>
                </div>
            `;
            
            document.getElementById('invoiceContent').innerHTML = invoiceContent;
            showModal('invoiceModal');
        }

        function printSaleInvoice(saleId) {
            const sale = sales.find(s => s.id === saleId);
            if (!sale) return;
            
            viewSale(saleId);
        }

        function printInvoice() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                    <head>
                        <title>فاتورة مبيعات</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
                            th { background-color: #f2f2f2; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .totals { text-align: left; margin-left: auto; width: 300px; }
                            @media print {
                                body { padding: 0; }
                                button { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        ${document.getElementById('invoiceContent').innerHTML}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        function deleteSale(saleId) {
            if (confirm('هل أنت متأكد من حذف هذه العملية؟')) {
                const index = sales.findIndex(s => s.id === saleId);
                if (index !== -1) {
                    // استعادة المخزون
                    const sale = sales[index];
                    sale.items.forEach(item => {
                        const productIndex = products.findIndex(p => p.id === item.productId);
                        if (productIndex !== -1) {
                            products[productIndex].quantity += item.quantity;
                        }
                    });
                    
                    // استعادة رصيد العميل
                    if (sale.customerId) {
                        const customerIndex = customers.findIndex(c => c.id === sale.customerId);
                        if (customerIndex !== -1) {
                            customers[customerIndex].totalPurchases -= sale.total;
                            customers[customerIndex].balance -= sale.remaining;
                        }
                    }
                    
                    // حذف العملية
                    sales.splice(index, 1);
                    
                    // حفظ التغييرات
                    saveToStorage('sales', sales);
                    saveToStorage('products', products);
                    saveToStorage('customers', customers);
                    
                    // تحديث العرض
                    loadSalesTable();
                    loadProductsTable();
                    loadCustomersTable();
                    loadDashboardData();
                    loadInventoryTable();
                    
                    showMessage('تم حذف العملية بنجاح', 'success');
                }
            }
        }

        // ========== إدارة المشتريات ==========
        function loadPurchasesTable() {
            const tbody = document.getElementById('purchasesBody');
            tbody.innerHTML = '';
            
            purchases.forEach(purchase => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${purchase.invoiceNo}</td>
                    <td>${purchase.date}</td>
                    <td>${purchase.supplierName}</td>
                    <td>${purchase.totalItems || 0}</td>
                    <td>${formatCurrency(purchase.total || 0)}</td>
                    <td>${formatCurrency(purchase.paid || 0)}</td>
                    <td>${formatCurrency(purchase.remaining || 0)}</td>
                    <td><span class="status-badge ${getStatusClass(purchase.status || '')}">${purchase.status || 'غير محدد'}</span></td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="viewPurchase(${purchase.id})">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deletePurchase(${purchase.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ========== إدارة العملاء ==========
        function loadCustomersTable() {
            const tbody = document.getElementById('customersBody');
            tbody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${formatCurrency(customer.totalPurchases)}</td>
                    <td>${formatCurrency(customer.balance)}</td>
                    <td>${customer.regDate}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editCustomer(${customer.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteCustomer(${customer.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const tbody = document.getElementById('customersBody');
            tbody.innerHTML = '';
            
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm) ||
                customer.code.toLowerCase().includes(searchTerm) ||
                customer.phone.includes(searchTerm) ||
                (customer.email && customer.email.toLowerCase().includes(searchTerm))
            );
            
            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.code}</td>
                    <td>${customer.name}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.email || '-'}</td>
                    <td>${formatCurrency(customer.totalPurchases)}</td>
                    <td>${formatCurrency(customer.balance)}</td>
                    <td>${customer.regDate}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editCustomer(${customer.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteCustomer(${customer.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function initCustomerForm() {
            document.getElementById('customerModalTitle').textContent = 'إضافة عميل جديد';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            
            // توليد كود جديد
            const nextId = customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1;
            document.getElementById('customerCode').value = 'CUST' + nextId.toString().padStart(3, '0');
        }

        function saveCustomer(event) {
            event.preventDefault();
            
            const customerId = document.getElementById('customerId').value;
            const customer = {
                id: customerId ? parseInt(customerId) : customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
                code: document.getElementById('customerCode').value,
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                email: document.getElementById('customerEmail').value,
                address: document.getElementById('customerAddress').value,
                totalPurchases: 0,
                balance: 0,
                regDate: new Date().toISOString().split('T')[0]
            };
            
            if (customerId) {
                // تعديل عميل موجود
                const index = customers.findIndex(c => c.id === parseInt(customerId));
                if (index !== -1) {
                    // الحفاظ على البيانات القديمة
                    customer.totalPurchases = customers[index].totalPurchases;
                    customer.balance = customers[index].balance;
                    customer.regDate = customers[index].regDate;
                    customers[index] = customer;
                }
            } else {
                // إضافة عميل جديد
                customers.push(customer);
            }
            
            saveToStorage('customers', customers);
            closeModal('customerModal');
            loadCustomersTable();
            loadDashboardData();
            showMessage('تم حفظ العميل بنجاح', 'success');
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (customer) {
                document.getElementById('customerModalTitle').textContent = 'تعديل العميل';
                document.getElementById('customerId').value = customer.id;
                document.getElementById('customerCode').value = customer.code;
                document.getElementById('customerName').value = customer.name;
                document.getElementById('customerPhone').value = customer.phone;
                document.getElementById('customerEmail').value = customer.email;
                document.getElementById('customerAddress').value = customer.address;
                
                showModal('customerModal');
            }
        }

        function deleteCustomer(id) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                const index = customers.findIndex(c => c.id === id);
                if (index !== -1) {
                    customers.splice(index, 1);
                    saveToStorage('customers', customers);
                    loadCustomersTable();
                    loadDashboardData();
                    showMessage('تم حذف العميل بنجاح', 'success');
                }
            }
        }

        // ========== إدارة الموردين ==========
        function loadSuppliersTable() {
            const tbody = document.getElementById('suppliersBody');
            tbody.innerHTML = '';
            
            suppliers.forEach(supplier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.address || '-'}</td>
                    <td>${formatCurrency(supplier.totalPurchases)}</td>
                    <td>${formatCurrency(supplier.balance)}</td>
                    <td>${supplier.regDate}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editSupplier(${supplier.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteSupplier(${supplier.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterSuppliers() {
            const searchTerm = document.getElementById('supplierSearch').value.toLowerCase();
            const tbody = document.getElementById('suppliersBody');
            tbody.innerHTML = '';
            
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm) ||
                supplier.code.toLowerCase().includes(searchTerm) ||
                supplier.phone.includes(searchTerm) ||
                (supplier.email && supplier.email.toLowerCase().includes(searchTerm))
            );
            
            filteredSuppliers.forEach(supplier => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${supplier.code}</td>
                    <td>${supplier.name}</td>
                    <td>${supplier.phone}</td>
                    <td>${supplier.email || '-'}</td>
                    <td>${supplier.address || '-'}</td>
                    <td>${formatCurrency(supplier.totalPurchases)}</td>
                    <td>${formatCurrency(supplier.balance)}</td>
                    <td>${supplier.regDate}</td>
                    <td>
                        <div class="actions">
                            <div class="action-btn" style="background-color: #3498db;" onclick="editSupplier(${supplier.id})">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn" style="background-color: #e74c3c;" onclick="deleteSupplier(${supplier.id})">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function initSupplierForm() {
            document.getElementById('supplierModalTitle').textContent = 'إضافة مورد جديد';
            document.getElementById('supplierForm').reset();
            document.getElementById('supplierId').value = '';
            
            // توليد كود جديد
            const nextId = suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1;
            document.getElementById('supplierCode').value = 'SUPP' + nextId.toString().padStart(3, '0');
        }

        function saveSupplier(event) {
            event.preventDefault();
            
            const supplierId = document.getElementById('supplierId').value;
            const supplier = {
                id: supplierId ? parseInt(supplierId) : suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1,
                code: document.getElementById('supplierCode').value,
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                email: document.getElementById('supplierEmail').value,
                address: document.getElementById('supplierAddress').value,
                totalPurchases: 0,
                balance: 0,
                regDate: new Date().toISOString().split('T')[0]
            };
            
            if (supplierId) {
                // تعديل مورد موجود
                const index = suppliers.findIndex(s => s.id === parseInt(supplierId));
                if (index !== -1) {
                    // الحفاظ على البيانات القديمة
                    supplier.totalPurchases = suppliers[index].totalPurchases;
                    supplier.balance = suppliers[index].balance;
                    supplier.regDate = suppliers[index].regDate;
                    suppliers[index] = supplier;
                }
            } else {
                // إضافة مورد جديد
                suppliers.push(supplier);
            }
            
            saveToStorage('suppliers', suppliers);
            closeModal('supplierModal');
            loadSuppliersTable();
            showMessage('تم حفظ المورد بنجاح', 'success');
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (supplier) {
                document.getElementById('supplierModalTitle').textContent = 'تعديل المورد';
                document.getElementById('supplierId').value = supplier.id;
                document.getElementById('supplierCode').value = supplier.code;
                document.getElementById('supplierName').value = supplier.name;
                document.getElementById('supplierPhone').value = supplier.phone;
                document.getElementById('supplierEmail').value = supplier.email;
                document.getElementById('supplierAddress').value = supplier.address;
                
                showModal('supplierModal');
            }
        }

        function deleteSupplier(id) {
            if (confirm('هل أنت متأكد من حذف هذا المورد؟')) {
                const index = suppliers.findIndex(s => s.id === id);
                if (index !== -1) {
                    suppliers.splice(index, 1);
                    saveToStorage('suppliers', suppliers);
                    loadSuppliersTable();
                    showMessage('تم حذف المورد بنجاح', 'success');
                }
            }
        }

        // ========== إدارة المخزون ==========
        function loadInventoryTable() {
            const tbody = document.getElementById('inventoryBody');
            tbody.innerHTML = '';
            
            products.forEach(product => {
                const totalValue = product.quantity * product.purchasePrice;
                const status = product.quantity === 0 ? 'نفذ' : 
                              product.quantity <= product.minQuantity ? 'منخفض' : 'جيد';
                const statusClass = product.quantity === 0 ? 'danger' : 
                                   product.quantity <= product.minQuantity ? 'warning' : 'success';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.name}</td>
                    <td>${getCategoryName(product.category)}</td>
                    <td>${product.quantity}</td>
                    <td>${product.minQuantity}</td>
                    <td>${formatCurrency(product.purchasePrice)}</td>
                    <td>${formatCurrency(totalValue)}</td>
                    <td>المخزن الرئيسي</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function initAdjustmentForm() {
            document.getElementById('adjustmentForm').reset();
            document.getElementById('adjustmentProduct').value = '';
            document.getElementById('currentQuantity').value = '';
            document.getElementById('newQuantity').value = '';
            
            // ملء قائمة المنتجات
            const select = document.getElementById('adjustmentProduct');
            select.innerHTML = '<option value="">اختر الصنف</option>';
            
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.quantity} متاح)`;
                select.appendChild(option);
            });
        }

        function updateCurrentQuantity() {
            const productId = parseInt(document.getElementById('adjustmentProduct').value);
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('currentQuantity').value = product.quantity;
                }
            }
        }

        function adjustProductStock(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('adjustmentProduct').value = id;
                document.getElementById('currentQuantity').value = product.quantity;
                showModal('adjustmentModal');
            }
        }

        function saveAdjustment(event) {
            event.preventDefault();
            
            const productId = parseInt(document.getElementById('adjustmentProduct').value);
            const adjustmentType = document.getElementById('adjustmentType').value;
            const currentQuantity = parseInt(document.getElementById('currentQuantity').value);
            const newQuantity = parseInt(document.getElementById('newQuantity').value);
            const reason = document.getElementById('adjustmentReason').value;
            const notes = document.getElementById('adjustmentNotes').value;
            
            if (!productId || isNaN(newQuantity)) {
                showMessage('يرجى اختيار منتج وكمية صحيحة', 'error');
                return;
            }
            
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex === -1) {
                showMessage('المنتج غير موجود', 'error');
                return;
            }
            
            let finalQuantity = currentQuantity;
            switch(adjustmentType) {
                case 'add':
                    finalQuantity = currentQuantity + newQuantity;
                    break;
                case 'subtract':
                    finalQuantity = currentQuantity - newQuantity;
                    if (finalQuantity < 0) {
                        showMessage('الكمية النهائية لا يمكن أن تكون أقل من الصفر', 'error');
                        return;
                    }
                    break;
                case 'set':
                    finalQuantity = newQuantity;
                    break;
            }
            
            // تحديث كمية المنتج
            products[productIndex].quantity = finalQuantity;
            
            // تسجيل حركة المخزون
            const movement = {
                id: inventoryMovements.length > 0 ? Math.max(...inventoryMovements.map(m => m.id)) + 1 : 1,
                productId: productId,
                productName: products[productIndex].name,
                date: new Date().toISOString().split('T')[0],
                type: 'تعديل',
                previousQuantity: currentQuantity,
                newQuantity: finalQuantity,
                difference: finalQuantity - currentQuantity,
                reason: reason,
                notes: notes
            };
            
            inventoryMovements.push(movement);
            
            // حفظ البيانات
            saveToStorage('products', products);
            saveToStorage('inventoryMovements', inventoryMovements);
            
            // إغلاق النموذج وتحديث البيانات
            closeModal('adjustmentModal');
            loadProductsTable();
            loadInventoryTable();
            loadDashboardData();
            
            // إظهار رسالة نجاح
            showMessage('تم تعديل المخزون بنجاح', 'success');
        }

        // ========== الإعدادات ==========
        function updateSettingsForm() {
            document.getElementById('storeName').value = settings.storeName || '';
            document.getElementById('storeAddress').value = settings.storeAddress || '';
            document.getElementById('storePhone').value = settings.storePhone || '';
            document.getElementById('minStockAlert').value = settings.minStockAlert || 5;
            document.getElementById('vatRate').value = settings.vatRate || 15;
            
            // تحديث اسم المحل في الشريط الجانبي
            if (settings.storeName) {
                document.querySelector('.logo h2').textContent = settings.storeName;
            }
        }

        function saveSettings() {
            settings.storeName = document.getElementById('storeName').value;
            settings.storeAddress = document.getElementById('storeAddress').value;
            settings.storePhone = document.getElementById('storePhone').value;
            settings.minStockAlert = parseInt(document.getElementById('minStockAlert').value);
            settings.vatRate = parseFloat(document.getElementById('vatRate').value);
            
            saveToStorage('settings', settings);
            updateSettingsForm();
            showMessage('تم حفظ الإعدادات بنجاح', 'success');
        }

        // ========== الاستيراد والتصدير ==========
        function previewImportFile() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                
                // عرض معاينة للبيانات
                const previewDiv = document.getElementById('importPreview');
                const previewTable = document.getElementById('importPreviewTable');
                
                previewDiv.style.display = 'block';
                
                let tableHtml = '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">';
                const rowsToShow = Math.min(10, jsonData.length);
                
                for (let i = 0; i < rowsToShow; i++) {
                    tableHtml += '<tr>';
                    const row = jsonData[i];
                    for (let j = 0; j < Math.min(5, row.length); j++) {
                        tableHtml += `<td style="border: 1px solid #ddd; padding: 5px;">${row[j] || ''}</td>`;
                    }
                    tableHtml += '</tr>';
                }
                tableHtml += '</table>';
                
                previewTable.innerHTML = tableHtml;
            };
            
            reader.readAsArrayBuffer(file);
        }

        function importFromExcel() {
            const file = document.getElementById('importFile').files[0];
            const importType = document.getElementById('importType').value;
            const updateExisting = document.getElementById('importUpdateExisting').checked;
            
            if (!file) {
                showMessage('يرجى اختيار ملف للاستيراد', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                let importedCount = 0;
                let updatedCount = 0;
                
                switch(importType) {
                    case 'products':
                        jsonData.forEach(item => {
                            const existingIndex = products.findIndex(p => p.code === item['كود الصنف']);
                            
                            if (existingIndex !== -1 && updateExisting) {
                                // تحديث منتج موجود
                                products[existingIndex] = {
                                    id: products[existingIndex].id,
                                    code: item['كود الصنف'],
                                    name: item['اسم الصنف'],
                                    category: getCategoryCode(item['الفئة']),
                                    purchasePrice: item['سعر الشراء'],
                                    salePrice: item['سعر البيع'],
                                    quantity: item['الكمية'],
                                    minQuantity: item['الحد الأدنى'],
                                    supplier: item['المورد'],
                                    description: item['الوصف']
                                };
                                updatedCount++;
                            } else if (existingIndex === -1) {
                                // إضافة منتج جديد
                                const newProduct = {
                                    id: products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1,
                                    code: item['كود الصنف'],
                                    name: item['اسم الصنف'],
                                    category: getCategoryCode(item['الفئة']),
                                    purchasePrice: item['سعر الشراء'],
                                    salePrice: item['سعر البيع'],
                                    quantity: item['الكمية'],
                                    minQuantity: item['الحد الأدنى'],
                                    supplier: item['المورد'],
                                    description: item['الوصف']
                                };
                                products.push(newProduct);
                                importedCount++;
                            }
                        });
                        saveToStorage('products', products);
                        loadProductsTable();
                        loadInventoryTable();
                        break;
                        
                    case 'customers':
                        jsonData.forEach(item => {
                            const existingIndex = customers.findIndex(c => c.code === item['كود العميل']);
                            
                            if (existingIndex !== -1 && updateExisting) {
                                // تحديث عميل موجود
                                customers[existingIndex] = {
                                    id: customers[existingIndex].id,
                                    code: item['كود العميل'],
                                    name: item['اسم العميل'],
                                    phone: item['الهاتف'],
                                    email: item['البريد الإلكتروني'],
                                    address: item['العنوان'],
                                    totalPurchases: customers[existingIndex].totalPurchases,
                                    balance: customers[existingIndex].balance,
                                    regDate: customers[existingIndex].regDate
                                };
                                updatedCount++;
                            } else if (existingIndex === -1) {
                                // إضافة عميل جديد
                                const newCustomer = {
                                    id: customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
                                    code: item['كود العميل'],
                                    name: item['اسم العميل'],
                                    phone: item['الهاتف'],
                                    email: item['البريد الإلكتروني'],
                                    address: item['العنوان'],
                                    totalPurchases: 0,
                                    balance: 0,
                                    regDate: new Date().toISOString().split('T')[0]
                                };
                                customers.push(newCustomer);
                                importedCount++;
                            }
                        });
                        saveToStorage('customers', customers);
                        loadCustomersTable();
                        break;
                        
                    case 'suppliers':
                        jsonData.forEach(item => {
                            const existingIndex = suppliers.findIndex(s => s.code === item['كود المورد']);
                            
                            if (existingIndex !== -1 && updateExisting) {
                                // تحديث مورد موجود
                                suppliers[existingIndex] = {
                                    id: suppliers[existingIndex].id,
                                    code: item['كود المورد'],
                                    name: item['اسم المورد'],
                                    phone: item['الهاتف'],
                                    email: item['البريد الإلكتروني'],
                                    address: item['العنوان'],
                                    totalPurchases: suppliers[existingIndex].totalPurchases,
                                    balance: suppliers[existingIndex].balance,
                                    regDate: suppliers[existingIndex].regDate
                                };
                                updatedCount++;
                            } else if (existingIndex === -1) {
                                // إضافة مورد جديد
                                const newSupplier = {
                                    id: suppliers.length > 0 ? Math.max(...suppliers.map(s => s.id)) + 1 : 1,
                                    code: item['كود المورد'],
                                    name: item['اسم المورد'],
                                    phone: item['الهاتف'],
                                    email: item['البريد الإلكتروني'],
                                    address: item['العنوان'],
                                    totalPurchases: 0,
                                    balance: 0,
                                    regDate: new Date().toISOString().split('T')[0]
                                };
                                suppliers.push(newSupplier);
                                importedCount++;
                            }
                        });
                        saveToStorage('suppliers', suppliers);
                        loadSuppliersTable();
                        break;
                }
                
                closeModal('importModal');
                showMessage(`تم استيراد ${importedCount} سجل جديد وتحديث ${updatedCount} سجل موجود`, 'success');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function exportToExcel() {
            const exportType = document.getElementById('exportType').value;
            const fromDate = document.getElementById('exportFromDate').value;
            const toDate = document.getElementById('exportToDate').value;
            
            let data = [];
            let fileName = '';
            
            switch(exportType) {
                case 'products':
                    data = products.map(p => ({
                        'كود الصنف': p.code,
                        'اسم الصنف': p.name,
                        'الفئة': getCategoryName(p.category),
                        'سعر الشراء': p.purchasePrice,
                        'سعر البيع': p.salePrice,
                        'الكمية': p.quantity,
                        'الحد الأدنى': p.minQuantity,
                        'المورد': p.supplier,
                        'الوصف': p.description
                    }));
                    fileName = 'الأصناف.xlsx';
                    break;
                    
                case 'sales':
                    let filteredSales = sales;
                    if (fromDate || toDate) {
                        filteredSales = sales.filter(sale => {
                            const saleDate = new Date(sale.date);
                            const from = fromDate ? new Date(fromDate) : null;
                            const to = toDate ? new Date(toDate) : null;
                            
                            if (from && saleDate < from) return false;
                            if (to && saleDate > to) return false;
                            return true;
                        });
                    }
                    
                    data = filteredSales.map(s => ({
                        'رقم الفاتورة': s.invoiceNo,
                        'التاريخ': s.date,
                        'العميل': s.customerName,
                        'الإجمالي': s.total,
                        'الخصم': s.discount,
                        'المدفوع': s.paid,
                        'المتبقي': s.remaining,
                        'الحالة': s.status,
                        'الملاحظات': s.notes
                    }));
                    fileName = 'المبيعات.xlsx';
                    break;
                    
                case 'customers':
                    data = customers.map(c => ({
                        'كود العميل': c.code,
                        'اسم العميل': c.name,
                        'الهاتف': c.phone,
                        'البريد الإلكتروني': c.email,
                        'العنوان': c.address,
                        'إجمالي المشتريات': c.totalPurchases,
                        'الرصيد': c.balance,
                        'تاريخ التسجيل': c.regDate
                    }));
                    fileName = 'العملاء.xlsx';
                    break;
                    
                case 'suppliers':
                    data = suppliers.map(s => ({
                        'كود المورد': s.code,
                        'اسم المورد': s.name,
                        'الهاتف': s.phone,
                        'البريد الإلكتروني': s.email,
                        'العنوان': s.address,
                        'إجمالي المشتريات': s.totalPurchases,
                        'الرصيد': s.balance,
                        'تاريخ التسجيل': s.regDate
                    }));
                    fileName = 'الموردين.xlsx';
                    break;
                    
                case 'all':
                    exportAllData();
                    return;
            }
            
            if (data.length === 0) {
                showMessage('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'بيانات');
            
            XLSX.writeFile(wb, fileName);
            closeModal('exportModal');
            showMessage('تم تصدير البيانات بنجاح', 'success');
        }

        function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // تصدير الأصناف
            const productsData = products.map(p => ({
                'كود الصنف': p.code,
                'اسم الصنف': p.name,
                'الفئة': getCategoryName(p.category),
                'سعر الشراء': p.purchasePrice,
                'سعر البيع': p.salePrice,
                'الكمية': p.quantity,
                'الحد الأدنى': p.minQuantity,
                'المورد': p.supplier,
                'الوصف': p.description
            }));
            if (productsData.length > 0) {
                const productsWs = XLSX.utils.json_to_sheet(productsData);
                XLSX.utils.book_append_sheet(wb, productsWs, 'الأصناف');
            }
            
            // تصدير المبيعات
            const salesData = sales.map(s => ({
                'رقم الفاتورة': s.invoiceNo,
                'التاريخ': s.date,
                'العميل': s.customerName,
                'الإجمالي': s.total,
                'الخصم': s.discount,
                'المدفوع': s.paid,
                'المتبقي': s.remaining,
                'الحالة': s.status,
                'الملاحظات': s.notes
            }));
            if (salesData.length > 0) {
                const salesWs = XLSX.utils.json_to_sheet(salesData);
                XLSX.utils.book_append_sheet(wb, salesWs, 'المبيعات');
            }
            
            // تصدير العملاء
            const customersData = customers.map(c => ({
                'كود العميل': c.code,
                'اسم العميل': c.name,
                'الهاتف': c.phone,
                'البريد الإلكتروني': c.email,
                'العنوان': c.address,
                'إجمالي المشتريات': c.totalPurchases,
                'الرصيد': c.balance,
                'تاريخ التسجيل': c.regDate
            }));
            if (customersData.length > 0) {
                const customersWs = XLSX.utils.json_to_sheet(customersData);
                XLSX.utils.book_append_sheet(wb, customersWs, 'العملاء');
            }
            
            // تصدير الموردين
            const suppliersData = suppliers.map(s => ({
                'كود المورد': s.code,
                                'اسم المورد': s.name,
                                'الهاتف': s.phone,
                                'البريد الإلكتروني': s.email,
                                'العنوان': s.address,
                                'إجمالي المشتريات': s.totalPurchases,
                                'الرصيد': s.balance,
                                'تاريخ التسجيل': s.regDate
                            }));
            if (suppliersData.length > 0) {
                const suppliersWs = XLSX.utils.json_to_sheet(suppliersData);
                XLSX.utils.book_append_sheet(wb, suppliersWs, 'الموردين');
            }
            
            XLSX.writeFile(wb, 'جميع_البيانات.xlsx');
            closeModal('exportModal');
            showMessage('تم تصدير جميع البيانات بنجاح', 'success');
        }

        function exportToPDF() {
            showMessage('ميزة التصدير إلى PDF قيد التطوير', 'info');
        }

        function exportReport(reportType) {
            showModal('exportModal');
            document.getElementById('exportType').value = reportType;
        }

        // ========== دوال مساعدة ==========
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-EG', {
                style: 'currency',
                currency: 'EGP'
            }).format(amount || 0);
        }

        function getCategoryName(categoryCode) {
            const categories = {
                'computers': 'أجهزة الكمبيوتر',
                'electrical': 'الأدوات الكهربائية',
                'satellite': 'مستلزمات الدش',
                'accessories': 'إكسسوارات'
            };
            return categories[categoryCode] || categoryCode;
        }

        function getCategoryCode(categoryName) {
            const categories = {
                'أجهزة الكمبيوتر': 'computers',
                'الأدوات الكهربائية': 'electrical',
                'مستلزمات الدش': 'satellite',
                'إكسسوارات': 'accessories'
            };
            return categories[categoryName] || categoryName;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'مدفوعة': return 'success';
                case 'جزئي': return 'warning';
                case 'غير مدفوعة': return 'danger';
                default: return 'info';
            }
        }

        function showMessage(message, type) {
            // إنشاء عنصر الرسالة
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 25px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
            `;
            
            // تحديد لون الرسالة حسب النوع
            switch(type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#27ae60';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#e74c3c';
                    break;
                case 'warning':
                    messageDiv.style.backgroundColor = '#f39c12';
                    break;
                default:
                    messageDiv.style.backgroundColor = '#3498db';
            }
            
            messageDiv.textContent = message;
            
            // إضافة الرسالة للصفحة
            document.body.appendChild(messageDiv);
            
            // إزالة الرسالة بعد 3 ثواني
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
            
            // إضافة أنيميشن للرسالة
            if (!document.querySelector('#messageStyles')) {
                const style = document.createElement('style');
                style.id = 'messageStyles';
                style.textContent = `
                    @keyframes slideIn {
                        from { top: -100px; opacity: 0; }
                        to { top: 20px; opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { top: 20px; opacity: 1; }
                        to { top: -100px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // ========== دوال مساعدة للبيع ==========
        function editSaleProduct(index) {
            const product = saleProducts[index];
            document.getElementById('saleProduct').value = product.id;
            document.getElementById('saleQuantity').value = product.quantity;
            document.getElementById('salePricePerUnit').value = product.price;
            
            // حذف المنتج من القائمة
            removeSaleProduct(index);
        }

        function removeSaleProduct(index) {
            saleProducts.splice(index, 1);
            updateSaleProductsList();
            updateSaleTotals();
        }

        // ========== تقارير الأرباح ==========
        function generateProfitReport() {
            const fromDate = document.getElementById('profitFromDate').value;
            const toDate = document.getElementById('profitToDate').value;
            
            let filteredSales = sales;
            if (fromDate || toDate) {
                filteredSales = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    const from = fromDate ? new Date(fromDate) : null;
                    const to = toDate ? new Date(toDate) : null;
                    
                    if (from && saleDate < from) return false;
                    if (to && saleDate > to) return false;
                    return true;
                });
            }
            
            // حساب الأرباح
            let totalRevenue = 0;
            let totalCost = 0;
            let totalProfit = 0;
            
            filteredSales.forEach(sale => {
                totalRevenue += sale.total;
                
                sale.items.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (product) {
                        totalCost += product.purchasePrice * item.quantity;
                    }
                });
            });
            
            totalProfit = totalRevenue - totalCost;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100).toFixed(2) : 0;
            
            // عرض النتائج
            const profitSummary = document.getElementById('profitSummary');
            profitSummary.innerHTML = `
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #3498db;">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${formatCurrency(totalRevenue)}</h3>
                            <p>إجمالي الإيرادات</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #e74c3c;">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${formatCurrency(totalCost)}</h3>
                            <p>إجمالي التكلفة</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #27ae60;">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${formatCurrency(totalProfit)}</h3>
                            <p>صافي الربح</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background-color: #f39c12;">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stat-info">
                            <h3>${profitMargin}%</h3>
                            <p>هامش الربح</p>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>تفاصيل المبيعات (${filteredSales.length} عملية)</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>العميل</th>
                                <th>الإيرادات</th>
                                <th>التكلفة</th>
                                <th>الربح</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredSales.map(sale => {
                                let saleCost = 0;
                                sale.items.forEach(item => {
                                    const product = products.find(p => p.id === item.productId);
                                    if (product) {
                                        saleCost += product.purchasePrice * item.quantity;
                                    }
                                });
                                const saleProfit = sale.total - saleCost;
                                
                                return `
                                    <tr>
                                        <td>${sale.invoiceNo}</td>
                                        <td>${sale.date}</td>
                                        <td>${sale.customerName}</td>
                                        <td>${formatCurrency(sale.total)}</td>
                                        <td>${formatCurrency(saleCost)}</td>
                                        <td style="color: ${saleProfit >= 0 ? 'green' : 'red'}">${formatCurrency(saleProfit)}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
    </script>
</body>
</html>
